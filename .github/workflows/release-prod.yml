# SPDX-FileCopyrightText: Nextcloud contributors
# SPDX-License-Identifier: AGPL-3.0-or-later

name: Build and publish app release

on:
  workflow_run:
    workflows: ["Version Bump"]
    types:
      - completed
  release:
    types: [published]
  push:
    tags:
      - v*
      - '!v*-*'

env:
  APP_NAME: thesearchpage

jobs:
  build_and_publish:
    environment: release
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    name: "Release: build, sign and upload the app"
    strategy:
      matrix:
        php-versions: ["8.2"]
        nextcloud: ["stable31"]
        database: ["sqlite"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get release tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            # Triggered by tag push
            TAG="${GITHUB_REF#refs/tags/}"
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "Release triggered by tag push: $TAG"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            # Triggered by Version Bump workflow completion
            # Get the most recent tag
            TAG=$(git describe --tags --abbrev=0)
            TAG_COMMIT=$(git rev-list -n 1 "$TAG")
            WORKFLOW_HEAD="${{ github.event.workflow_run.head_sha }}"

            # Check if the tag was created AFTER the triggering commit
            # If Version Bump created a tag, it will be on a new commit (descendant of workflow head)
            # If no tag was created, the latest tag will be on an older commit
            if [ "$TAG_COMMIT" = "$WORKFLOW_HEAD" ]; then
              echo "Tag commit is the same as workflow head - no new tag was created"
              echo "should_release=false" >> $GITHUB_OUTPUT
            elif git merge-base --is-ancestor "$WORKFLOW_HEAD" "$TAG_COMMIT"; then
              echo "Tag $TAG was created after workflow head - proceeding with release"
              echo "should_release=true" >> $GITHUB_OUTPUT
              echo "tag=$TAG" >> $GITHUB_OUTPUT
            else
              echo "Tag $TAG (commit ${TAG_COMMIT:0:7}) is older than workflow head (${WORKFLOW_HEAD:0:7})"
              echo "Version Bump workflow did not create a new tag, skipping release"
              echo "should_release=false" >> $GITHUB_OUTPUT
            fi

            echo "Release triggered by workflow_run, latest tag: $TAG"
          elif [ "${{ github.event_name }}" = "release" ]; then
            # Triggered by release publication
            TAG="${{ github.event.release.tag_name }}"
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "Release triggered by release event: $TAG"
          else
            echo "Unknown trigger event: ${{ github.event_name }}"
            exit 1
          fi

      - name: Checkout tag
        if: steps.get_tag.outputs.should_release != 'false'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.get_tag.outputs.tag }}
          fetch-depth: 0

      - name: Install XML tools
        if: steps.get_tag.outputs.should_release != 'false'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y xmlstarlet

      - name: Validate tag matches info.xml version
        if: steps.get_tag.outputs.should_release != 'false'
        run: |
          TAG="${{ steps.get_tag.outputs.tag }}"

          # Validate XML file
          if ! xmlstarlet val -q appinfo/info.xml; then
            echo "Error: appinfo/info.xml is not valid XML"
            exit 1
          fi

          # Extract version from info.xml
          INFO_VERSION=$(xmlstarlet sel -t -v "//version" appinfo/info.xml)

          if [ -z "$INFO_VERSION" ]; then
            echo "Error: Could not extract version from appinfo/info.xml"
            exit 1
          fi

          # Extract version from tag (remove 'v' prefix)
          TAG_VERSION="${TAG#v}"

          echo "Tag version: $TAG_VERSION"
          echo "info.xml version: $INFO_VERSION"

          # Compare versions
          if [ "$TAG_VERSION" != "$INFO_VERSION" ]; then
            echo "Error: Version mismatch!"
            echo "  Tag version:      $TAG_VERSION"
            echo "  info.xml version: $INFO_VERSION"
            echo ""
            echo "The git tag and appinfo/info.xml version must match for a release."
            exit 1
          fi

          echo "Version validation passed: $INFO_VERSION"

      - name: Setup PHP
        if: steps.get_tag.outputs.should_release != 'false'
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-versions }}
          extensions: pdo_sqlite,pdo_mysql,pdo_pgsql,gd,zip
          coverage: none

      - name: Set up server non MySQL
        if: steps.get_tag.outputs.should_release != 'false'
        uses: SMillerDev/nextcloud-actions/setup-nextcloud@fae87e29aa7cdf1ea0b8033c67f60e75b10be2cd
        with:
          cron: false
          version: ${{ matrix.nextcloud }}
          database-type: ${{ matrix.database }}

      - name: Prime app build
        if: steps.get_tag.outputs.should_release != 'false'
        run: make

      - name: Configure server with app
        if: steps.get_tag.outputs.should_release != 'false'
        uses: SMillerDev/nextcloud-actions/setup-nextcloud-app@fae87e29aa7cdf1ea0b8033c67f60e75b10be2cd
        with:
          app: ${{ env.APP_NAME }}
          check-code: false

      - name: Create signed release archive
        if: steps.get_tag.outputs.should_release != 'false'
        run: |
          cd ../server/apps/${{ env.APP_NAME }} && make appstore
        env:
          app_private_key: ${{ secrets.APP_PRIVATE_KEY }}
          app_public_crt: ${{ secrets.APP_PUBLIC_CRT }}

      - name: Upload app tarball to release
        if: steps.get_tag.outputs.should_release != 'false'
        uses: svenstaro/upload-release-action@v2
        id: attach_to_release
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ../server/apps/${{ env.APP_NAME }}/build/artifacts/${{ env.APP_NAME }}.tar.gz
          asset_name: ${{ env.APP_NAME }}.tar.gz
          tag: ${{ steps.get_tag.outputs.tag }}
          release_name: ${{ steps.get_tag.outputs.tag }}
          overwrite: true

      - name: Upload app to Nextcloud appstore
        if: steps.get_tag.outputs.should_release != 'false'
        uses: R0Wi/nextcloud-appstore-push-action@v1
        with:
          app_name: ${{ env.APP_NAME }}
          appstore_token: ${{ secrets.APPSTORE_TOKEN }}
          download_url: ${{ steps.attach_to_release.outputs.browser_download_url }}
          app_private_key: ${{ secrets.APP_PRIVATE_KEY }}
          nightly: false

      - name: Delete crt and key from local storage
        if: steps.get_tag.outputs.should_release != 'false'
        run: rm -f ~/.nextcloud/certificates/*
