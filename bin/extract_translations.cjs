#!/bin/env node

const { glob } = require("glob");
const fs = require("fs");

const fileHeader = `
// SPDX-FileCopyrightText: Magnus Anderssen <magnus@magooweb.com>
// SPDX-License-Identifier: AGPL-3.0-or-later

/**
 * Don't change this file manually it is generated by the ./bin/extract_translation.cjs script
 * to satisfy Nextcloud's bot as it does not know how to read .svelte files.
 */
 
// @ts-ignore
const { t } = window;
`


async function run() {

  const files = [
      ...await glob("static/*/src/**/*.svelte"),
      ...await glob("static/*/src/**/*.ts")
      ]

  // Match both translate and t (or any alias), handle multi-line, capture the string
  // Pattern: (translate|t)(APP_NAME, 'captured string' or "captured string")
  // This regex separately matches single-quoted and double-quoted strings
  // Handles escaped quotes (\' or \") and other escaped characters (\\n, \\t, etc.)
  const regexp = new RegExp(
    "(?:translate|t)\\s*\\(\\s*APP_NAME\\s*,\\s*(?:'((?:[^'\\\\]|\\\\.)*)'|\"((?:[^\"\\\\]|\\\\.)*)\")",
    "gms"
  );

  const translations = new Set(["All providers"]);

  files.forEach(filepath => {
    console.log(`Grabbing from ${filepath}`);
    const content = fs.readFileSync(filepath, 'utf8');

    const matches = content.matchAll(regexp);

    let foundAny = false;
    for (const match of matches) {
      foundAny = true;
      // match[1] is single-quoted string, match[2] is double-quoted string
      // One of them will be undefined, so use whichever one matched
      let translation = match[1] || match[2];
      if (translation) {
        // Unescape escaped quotes and other escape sequences that might be in the string
        translation = translation
          .replace(/\\'/g, "'")
          .replace(/\\"/g, '"')
          .replace(/\\\\/g, '\\');
        translations.add(translation);
      }
    }
  });

  const result = [fileHeader];
  let counter = 0;

  const englishLabels = [...translations];
  englishLabels.sort();

  englishLabels.forEach(translation => {
    // Escape single quotes in the translation string
    const escaped = translation.replace(/'/g, "\\'");

    // Extract parameters from the translation (anything in {paramName})
    const paramMatches = translation.matchAll(/\{([^}]+)\}/g);
    const params = [];
    for (const match of paramMatches) {
      params.push(match[1]);
    }

    // If there are parameters, add them as a dummy object
    if (params.length > 0) {
      const paramObj = params.map(p => `${p}: ''`).join(', ');
      result.push(`const label${counter} = t('thesearchpage', '${escaped}', { ${paramObj} });`);
    } else {
      result.push(`const label${counter} = t('thesearchpage', '${escaped}');`);
    }
    counter++;
  });

  for (let i = 0; i < counter; i++) {
    result.push(`console.log(label${i});`)
  }

  fs.writeFileSync("src/fakeLabels.ts", result.join('\n') + '\n');
  console.log(`Done - extracted ${translations.size} unique translations`)
}

run();
