#!/bin/env node

const { glob } = require("glob");
const fs = require("fs");

const fileHeader = `
// SPDX-FileCopyrightText: Magnus Anderssen <magnus@magooweb.com>
// SPDX-License-Identifier: AGPL-3.0-or-later

/**
 * Don't change this file manually it is generated by the ./bin/extract_translation.cjs script
 * to satisfy Nextcloud's bot as it does not know how to read .svelte files.
 */
 
// @ts-ignore
const { t } = window;
`


async function run() {

  const files = [
      ...await glob("static/*/src/**/*.svelte"),
      ...await glob("static/*/src/**/*.ts")
      ]

  // Match both translate and t (or any alias), handle multi-line, capture the string
  // Pattern: (translate|t)( APP_NAME, 'captured string'
  const regexp = new RegExp("(?:translate|t)\\s*\\(\\s*APP_NAME\\s*,\\s*['\"]([^'\"]+)['\"]", "gms");

  const translations = new Set(["All providers"]);

  files.forEach(filepath => {
    console.log(`Grabbing from ${filepath}`);
    const content = fs.readFileSync(filepath, 'utf8');

    const matches = content.matchAll(regexp);

    let foundAny = false;
    for (const match of matches) {
      foundAny = true;
      translations.add(match[1]);
    }
  });

  const result = [fileHeader];
  let counter = 0;

  const englishLabels = [...translations];
  englishLabels.sort();

  englishLabels.forEach(translation => {
    // Escape single quotes in the translation string
    const escaped = translation.replace(/'/g, "\\'");
    result.push(`const label${counter} = t('thesearchpage', '${escaped}');`);
    counter++;
  });

  for (let i = 0; i < counter; i++) {
    result.push(`console.log(label${i});`)
  }

  fs.writeFileSync("src/fakeLabels.ts", result.join('\n') + '\n');
  console.log(`Done - extracted ${translations.size} unique translations`)
}

run();
